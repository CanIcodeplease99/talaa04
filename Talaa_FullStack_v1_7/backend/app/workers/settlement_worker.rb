class SettlementWorker; include Sidekiq::Worker; def perform(transfer_id); s=Settlement.find_by(transfer_id:transfer_id); return unless s; resp=Gateway::DomesticRouter.new.transfer_mobile_money(msisdn:s.meta['msisdn'], network:s.meta['network'], amount_cents:s.amount_cents, reference:s.transfer_id, idempotency_key:s.transfer_id); if resp[:ok]; s.update!(status:'sent', rail:resp[:provider]); Metrics.inc(:transfers_sent_ok); else; s.update!(status:'failed', last_error:resp[:error]||resp[:status]); Metrics.inc(:transfers_failed); end; end; end
